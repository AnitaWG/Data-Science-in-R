---
title: "Rmongo"
author: "Dingchong"
date: "Wednesday, April 15, 2015"
output: html_document
---


# 畅游mongodb环境访问
参考<http://cran.r-project.org/web/packages/rmongodb/vignettes/rmongodb_introduction.html>


## 连接数据库
```{r}
library('rmongodb')
mcon= mongo.create(host = "10.127.133.122:27017", name = "", username = "",
                   password = "", db = "admin", timeout = 0L )

mongo.is.connected(mcon)
```

## 获取数据库相关信息
```{r}
mongo.get.databases(mcon) # show databases
```

```{r}
# show tables
mongo.get.database.collections(mcon, "vipDB")[1:5]
```

## 查询表信息
```{r}
# nrows
mongo.count( mcon, "vipDB.account" ) 

# relation表第一行
mongo.find.one( mcon, "vipDB.relation")
# 符合条件的第一行，用query=list（）写条件
mongo.find.one( mcon, "vipDB.relation", query = list( cnMaster='wjainiqing@game.sohu.com'))
mongo.find.one( mcon, "vipDB.relation", list( status= 1 ))
# 父子键值之间用.连接
mongo.find.one( mcon , "vipDB.account" , list( accountInfo.vipPay = 6 ) )
# 多条件的查询 select * from tb where a=xx and b= xx limit 1
mongo.find.one( mcon , "vipDB.account" , 
    list( accountInfo.vipPay = 6, accountInfo.vipCost = 9 ) )
# 指定select的列，运行不太好!!!
mongo.find.one( mcon , "vipDB.account" , 
     query = list( accountInfo.vipPay = 6, accountInfo.vipCost = 9 ), 
     fields = list( "accountInfo.uin" ))

# 查询数据的对接, BSON to list，读取数据的类型转换, simplify与否决定数据结构是否拉平
oneline = mongo.find.one( mcon , "vipDB.account" ) 
tmp = mongo.bson.to.list(oneline, simplify = F )
tmp$accountInfo$games = iconv( tmp$accountInfo$games , 'utf8', 'gbk') # 中文麻烦!!!
tmp[[2]]

# 查询多列
# select * from tb where a = xx 
callback = mongo.find.all(mcon, ns = "marketingStat.report_2efc00_2015-04-13" ,
  query =list(gm = 'GM_8962')) 
head(callback)

# select a from tb where b = xx，select有问题!!!
mongo.find.all( mcon , "vipDB.account" , 
                list( accountInfo.vipPay = 6, accountInfo.vipCost = 9 )  )[1:5]
```

## 写入数据

```{r}
# drop table 
mongo.drop( mcon, "test.rabc" )

## Build a Dataset
a <- mongo.bson.from.JSON( '{"ident":"a", "name":"Markus", "age":33}' )
b <- mongo.bson.from.JSON( '{"ident":"b", "name":"MongoSoup", "age":1}' )
c <- mongo.bson.from.JSON( '{"ident":"c", "name":"UseR", "age":18}' )

# insert data
mongo.insert.batch( mcon, "test.rabc" , list(a,b,c) )
mongo.insert.batch( mcon, "test.rabc" , list(a,b,c) )
mongo.find.all( mcon, "test.rabc" )
```

## 修改表内数值
mongo.update(mongo, ns, criteria, objNew, flags = 0L)  
   
flags(integer vector) A list of optional flags governing the operation:    
-mongo.update.upsert: insert ObjNew into the database if no record matching criteria is found.   
-mongo.update.multi: update multiple records rather than just the first one matched by criteria.   
-mongo.update.basic: Perform a basic update.   
   
update mothod: $inc增加, $set修改, $push   
- inc: 原值基础上+
- set: 原值修改
- push: ???
```{r}

# update data, 
mongo.update(mcon, "test.rabc", 
  criteria = list(ident = 'b' ), 
  objNew = list('$inc' = list('age' = 3)), 
  flags = mongo.update.multi ) # flags = 0L/1L 只改第一个,2L改两个...

mongo.find.all( mcon, "test.rabc" )
mongo.drop( mcon, "test.rabc" )
```

创建索引   
```{r}
# Creating an index for the field 'ident'
mongo.index.create(mcon, "test.rabc", list('ident' = 1))
```

把dataframe导入mongo:目前的方法是每行转换成json再插入，效率不高
```{r}

## build a dataframe to mongodb
mongo.drop( mcon, "test.riris" )
data(iris)

library(RJSONIO)

for ( i in  1:nrow(iris) ) {
  t = toJSON( iris[ i, ], container = T, collapse = "", .withNames = T  ) 
  d = mongo.bson.from.JSON( t )
  mongo.insert.batch( mcon, "test.riris" , list( d) )
}

iris.mongo = mongo.find.all( mcon, "test.riris" )
iris.mongo = as.data.frame(iris.mongo)
head(iris.mongo)

```

## 关闭连接
```{r}
mongo.destroy( mcon )
```



